- name: Cleanup previous test container
  crystian.incus.incus_instance:
    name: "test-config-container"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    force: true
    remote_image: "images:alpine/edge"
  ignore_errors: true

- name: Cleanup previous test container (multi)
  crystian.incus.incus_instance:
    name: "test-config-multi"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    force: true
  ignore_errors: true


- name: Create a test container
  crystian.incus.incus_instance:
    name: "test-config-container"
    remote_image: "images:alpine/edge"
    remote: "{{ target_remote | default(omit) }}"
    state: present
    started: true

- name: Set memory limit
  crystian.incus.incus_config:
    instance_name: "test-config-container"
    remote: "{{ target_remote | default(omit) }}"
    config:
      limits.memory: "128MiB"
  register: result

- name: Assert memory limit set (changed)
  assert:
    that:
      - result.changed == true

- name: Set memory limit again (idempotency)
  crystian.incus.incus_config:
    instance_name: "test-config-container"
    remote: "{{ target_remote | default(omit) }}"
    config:
      limits.memory: "128MiB"
  register: result

- name: Assert memory limit unchanged
  assert:
    that:
      - result.changed == false

- name: Create dummy folder for test (local)
  command: mkdir -p /tmp/incus_test_vol
  when: target_remote is not defined

- name: Create dummy folder for test (remote)
  crystian.incus.incus_exec:
    instance_name: "test-infra-vm"
    command: "mkdir -p /tmp/incus_test_vol"
  when: target_remote is defined

- name: Add disk device
  crystian.incus.incus_config:
    instance_name: "test-config-container"
    remote: "{{ target_remote | default(omit) }}"
    devices:
      testdisk:
        type: disk
        source: /tmp/incus_test_vol
        path: /mnt/test
  register: result

- name: Assert disk added
  assert:
    that:
      - result.changed == true

- name: Unset config
  crystian.incus.incus_config:
    instance_name: "test-config-container"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    config:
      - limits.memory
  register: result

- name: Assert config unset
  assert:
    that:
      - result.changed == true

- name: Remove device
  crystian.incus.incus_config:
    instance_name: "test-config-container"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    devices:
      - testdisk
  register: result

- name: Assert device removed
  assert:
    that:
      - result.changed == true

- name: Clean up temporary folder
  file:
    path: /tmp/incus_test_vol
    state: absent
  when: target_remote is not defined

- name: Clean up temporary folder (remote)
  crystian.incus.incus_exec:
    instance_name: "test-infra-vm"
    command: "rm -rf /tmp/incus_test_vol"
  when: target_remote is defined

- name: Create container for multiple config test
  crystian.incus.incus_instance:
    name: "test-config-multi"
    remote_image: "images:alpine/edge"
    remote: "{{ target_remote | default(omit) }}"
    state: present
    started: true

- name: Set multiple config keys
  crystian.incus.incus_config:
    instance_name: "test-config-multi"
    remote: "{{ target_remote | default(omit) }}"
    config:
      limits.cpu: "1"
      limits.memory: "128MiB"
  register: result_multi

- name: Assert multiple config keys set
  assert:
    that:
      - result_multi.changed == true

- name: Verify multiple keys (lookup)
  set_fact:
    multi_config: "{{ query('crystian.incus.incus_config', 'test-config-multi', remote=(target_remote | default('local'))) | first }}"

- name: Assert multiple keys verification
  assert:
    that:
      - multi_config.config['limits.cpu'] == '1'
      - multi_config.config['limits.memory'] == '128MiB'

- name: Update one key, keep other (mixed state idempotency)
  crystian.incus.incus_config:
    instance_name: "test-config-multi"
    remote: "{{ target_remote | default(omit) }}"
    config:
      limits.cpu: "2"
      limits.memory: "128MiB"
  register: result_mixed

- name: Assert mixed state update
  assert:
    that:
      - result_mixed.changed == true

- name: Verify mixed update (lookup)
  set_fact:
    mixed_config: "{{ query('crystian.incus.incus_config', 'test-config-multi', remote=(target_remote | default('local'))) | first }}"

- name: Assert mixed verification
  assert:
    that:
      - mixed_config.config['limits.cpu'] == '2'
      - mixed_config.config['limits.memory'] == '128MiB'

- name: Cleanup multiple config test
  crystian.incus.incus_instance:
    name: "test-config-multi"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    force: true
  ignore_errors: true

# === TRUST TESTS ===
- name: Generate test certificate
  command: openssl req -x509 -newkey rsa:4096 -keyout /tmp/key.pem -out /tmp/cert.pem -days 1 -nodes -subj "/CN=test-trust"
  args:
    creates: /tmp/cert.pem

- name: Wait for certificate to be valid (clock skew fix)
  pause:
    seconds: 5

- name: Read certificate
  slurp:
    src: /tmp/cert.pem
  register: cert_content

- name: Add trust
  crystian.incus.incus_config:
    trust:
      name: test-trust-client
      cert: "{{ cert_content.content | b64decode }}"
      type: client
    state: present
    remote: "{{ target_remote | default(omit) }}"
  register: trust_add

- name: Assert trust added
  assert:
    that:
      - trust_add.changed == true

- name: Add trust idempotent
  crystian.incus.incus_config:
    trust:
      name: test-trust-client
      cert: "{{ cert_content.content | b64decode }}"
      type: client
    state: present
    remote: "{{ target_remote | default(omit) }}"
  register: trust_add_idemp

- name: Assert trust add idempotent
  assert:
    that:
      - trust_add_idemp.changed == false

- name: Remove trust
  crystian.incus.incus_config:
    trust:
      name: test-trust-client
    state: absent
    remote: "{{ target_remote | default(omit) }}"
  register: trust_remove

- name: Assert trust removed
  assert:
    that:
      - trust_remove.changed == true

- name: Remove trust idempotent
  crystian.incus.incus_config:
    trust:
      name: test-trust-client
    state: absent
    remote: "{{ target_remote | default(omit) }}"
  register: trust_remove_idemp

- name: Assert trust remove idempotent
  assert:
    that:
      - trust_remove_idemp.changed == false

- name: Cleanup certs
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/key.pem
    - /tmp/cert.pem

