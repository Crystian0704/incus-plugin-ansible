- name: Cleanup previous test container
  crystian.incus.incus_instance:
    name: "test-config-container"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    force: true
    remote_image: "images:alpine/edge"
  ignore_errors: true

- name: Cleanup previous test container (multi)
  crystian.incus.incus_instance:
    name: "test-config-multi"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    force: true
  ignore_errors: true


- name: Create a test container
  crystian.incus.incus_instance:
    name: "test-config-container"
    remote_image: "images:alpine/edge"
    remote: "{{ target_remote | default(omit) }}"
    state: present
    started: true

- name: Set memory limit
  crystian.incus.incus_config:
    instance_name: "test-config-container"
    remote: "{{ target_remote | default(omit) }}"
    config:
      limits.memory: "128MiB"
  register: result

- name: Assert memory limit set (changed)
  assert:
    that:
      - result.changed == true

- name: Set memory limit again (idempotency)
  crystian.incus.incus_config:
    instance_name: "test-config-container"
    remote: "{{ target_remote | default(omit) }}"
    config:
      limits.memory: "128MiB"
  register: result

- name: Assert memory limit unchanged
  assert:
    that:
      - result.changed == false

- name: Create dummy folder for test (local)
  command: mkdir -p /tmp/incus_test_vol
  when: target_remote is not defined

- name: Create dummy folder for test (remote)
  crystian.incus.incus_exec:
    instance_name: "test-infra-vm"
    command: "mkdir -p /tmp/incus_test_vol"
  when: target_remote is defined

- name: Add disk device
  crystian.incus.incus_config:
    instance_name: "test-config-container"
    remote: "{{ target_remote | default(omit) }}"
    devices:
      testdisk:
        type: disk
        source: /tmp/incus_test_vol
        path: /mnt/test
  register: result

- name: Assert disk added
  assert:
    that:
      - result.changed == true

- name: Unset config
  crystian.incus.incus_config:
    instance_name: "test-config-container"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    config:
      - limits.memory
  register: result

- name: Assert config unset
  assert:
    that:
      - result.changed == true

- name: Remove device
  crystian.incus.incus_config:
    instance_name: "test-config-container"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    devices:
      - testdisk
  register: result

- name: Assert device removed
  assert:
    that:
      - result.changed == true

- name: Clean up temporary folder
  file:
    path: /tmp/incus_test_vol
    state: absent
  when: target_remote is not defined

- name: Clean up temporary folder (remote)
  crystian.incus.incus_exec:
    instance_name: "test-infra-vm"
    command: "rm -rf /tmp/incus_test_vol"
  when: target_remote is defined



- name: Create container for multiple config test
  crystian.incus.incus_instance:
    name: "test-config-multi"
    remote_image: "images:alpine/edge"
    remote: "{{ target_remote | default(omit) }}"
    state: present
    started: true

- name: Set multiple config keys
  crystian.incus.incus_config:
    instance_name: "test-config-multi"
    remote: "{{ target_remote | default(omit) }}"
    config:
      limits.cpu: "1"
      limits.memory: "128MiB"
  register: result_multi

- name: Assert multiple config keys set
  assert:
    that:
      - result_multi.changed == true

- name: Verify multiple keys (command)
  command: "incus config show {{ (target_remote ~ ':') if target_remote is defined else '' }}test-config-multi"
  register: result_show_multi

- name: Assert multiple keys verification
  assert:
    that:
      - "'limits.cpu: \"1\"' in result_show_multi.stdout"
      - "'limits.memory: 128MiB' in result_show_multi.stdout"

- name: Update one key, keep other (mixed state idempotency)
  crystian.incus.incus_config:
    instance_name: "test-config-multi"
    remote: "{{ target_remote | default(omit) }}"
    config:
      limits.cpu: "2"
      limits.memory: "128MiB"
  register: result_mixed

- name: Assert mixed state update
  assert:
    that:
      - result_mixed.changed == true

- name: Verify mixed update
  command: "incus config show {{ (target_remote ~ ':') if target_remote is defined else '' }}test-config-multi"
  register: result_show_mixed

- name: Assert mixed verification
  assert:
    that:
      - "'limits.cpu: \"2\"' in result_show_mixed.stdout"
      - "'limits.memory: 128MiB' in result_show_mixed.stdout"

- name: Cleanup multiple config test
  crystian.incus.incus_instance:
    name: "test-config-multi"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    force: true

