- name: Cleanup project test
  crystian.incus.incus_project:
    name: "test-project"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
  ignore_errors: true

- name: Create project
  crystian.incus.incus_project:
    name: "test-project"
    remote: "{{ target_remote | default(omit) }}"
    description: "Test Project"
    config:
      features.images: "false"
      limits.containers: "5"
  register: project_create

- name: Assert create
  assert:
    that:
      - project_create.changed == true

- name: Update project (idempotence)
  crystian.incus.incus_project:
    name: "test-project"
    remote: "{{ target_remote | default(omit) }}"
    description: "Test Project"
    config:
      features.images: "false"
      limits.containers: "5"
  register: project_idem

- name: Assert idempotence
  assert:
    that:
      - project_idem.changed == false

- name: Update config
  crystian.incus.incus_project:
    name: "test-project"
    remote: "{{ target_remote | default(omit) }}"
    config:
      limits.containers: "10"
  register: project_update

- name: Assert update
  assert:
    that:
      - project_update.changed == true

- name: Verify update (lookup)
  set_fact:
    project_config: "{{ query('crystian.incus.incus_query', '/1.0/projects/test-project', remote=(target_remote | default('local'))) | first }}"

- name: Assert verify
  assert:
    that:
      - project_config.config['limits.containers'] == '10'

- name: Create project source file
  copy:
    dest: /tmp/test_project_source.yml
    content: |
      description: "Project from source"
      config:
        limits.containers: "3"
        features.profiles: "true"

- name: Create project from source
  crystian.incus.incus_project:
    name: "test-project-source"
    source: /tmp/test_project_source.yml
    remote: "{{ target_remote | default(omit) }}"
  register: project_source_create

- name: Assert source create
  assert:
    that:
      - project_source_create.changed == true
      
- name: Verify source (lookup)
  set_fact:
    project_source_config: "{{ query('crystian.incus.incus_query', '/1.0/projects/test-project-source', remote=(target_remote | default('local'))) | first }}"

- name: Assert source verify
  assert:
    that:
      - project_source_config.config['limits.containers'] == '3'

- name: Update source with override
  crystian.incus.incus_project:
    name: "test-project-source"
    source: /tmp/test_project_source.yml
    remote: "{{ target_remote | default(omit) }}"
    config:
      limits.containers: "7"
  register: project_source_update

- name: Assert source update
  assert:
    that:
      - project_source_update.changed == true

- name: Cleanup source project
  crystian.incus.incus_project:
    name: "test-project-source"
    remote: "{{ target_remote | default(omit) }}"
    state: absent

- name: Delete project
  crystian.incus.incus_project:
    name: "test-project"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
  register: project_delete

- name: Assert delete
  assert:
    that:
      - project_delete.changed == true

- name: Create project with limits
  crystian.incus.incus_project:
    name: "test-limits"
    remote: "{{ target_remote | default(omit) }}"
    config:
      features.images: "false"
      features.profiles: "false"
      limits.containers: "1"
    state: present

- name: Create first instance (should succeed)
  crystian.incus.incus_instance:
    name: "inst1"
    project: "test-limits"
    remote: "{{ target_remote | default(omit) }}"
    remote_image: "images:alpine/edge"
    started: true
    state: present
  register: inst1

- name: Assert first instance created
  assert:
    that:
      - inst1.changed == true

- name: Create second instance (should fail)
  crystian.incus.incus_instance:
    name: "inst2"
    project: "test-limits"
    remote: "{{ target_remote | default(omit) }}"
    remote_image: "images:alpine/edge"
    started: true
    state: present
  register: inst2
  ignore_errors: true

- name: Assert second instance failed
  assert:
    that:
      - inst2.failed == true
      - "'reached' in inst2.stderr or 'limit' in inst2.stderr"

- name: Cleanup limit instances
  crystian.incus.incus_instance:
    name: "{{ item }}"
    project: "test-limits"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    force: true
  loop:
    - inst1
    - inst2
  ignore_errors: true

- name: Cleanup limit project
  crystian.incus.incus_project:
    name: "test-limits"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
