- name: Cleanup (pre-test)
  crystian.incus.incus_instance:
    name: "test-file"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    force: true
  ignore_errors: true

- name: Create test instance
  crystian.incus.incus_instance:
    name: "test-file"
    remote: "{{ target_remote | default(omit) }}"
    remote_image: "images:alpine/edge/cloud"
    started: true

- name: Wait for instance
  pause:
    seconds: 5

- name: Push content with owner/group
  crystian.incus.incus_file:
    name: "test-file"
    remote: "{{ target_remote | default(omit) }}"
    dest: "/root/test_content.txt"
    content: "content-data"
    mode: '0644'
    owner: root
    group: root
    state: pushed
  register: push_content

- name: Assert push content
  assert:
    that:
      - push_content.changed == true

- name: Verify content inside
  crystian.incus.incus_exec:
    name: "test-file"
    remote: "{{ target_remote | default(omit) }}"
    command: "cat /root/test_content.txt"
  register: verify_content

- name: Assert content match
  assert:
    that:
      - "'content-data' in verify_content.stdout"

- name: Push local file
  copy:
    content: "file-data"
    dest: "/tmp/local_test_file.txt"

- name: Push file
  crystian.incus.incus_file:
    name: "test-file"
    remote: "{{ target_remote | default(omit) }}"
    src: "/tmp/local_test_file.txt"
    dest: "/root/test_file.txt"
    state: pushed
  register: push_file

- name: Assert push file
  assert:
    that:
      - push_file.changed == true

- name: Verify file inside
  crystian.incus.incus_exec:
    name: "test-file"
    remote: "{{ target_remote | default(omit) }}"
    command: "cat /root/test_file.txt"
  register: verify_file

- name: Assert file match
  assert:
    that:
      - "'file-data' in verify_file.stdout"

- name: Pull file
  crystian.incus.incus_file:
    name: "test-file"
    remote: "{{ target_remote | default(omit) }}"
    src: "/root/test_content.txt"
    dest: "/tmp/pulled_content.txt"
    state: pulled
  register: pull_file

- name: Assert pull
  assert:
    that:
      - pull_file.changed == true

- name: Verify pulled content
  command: cat /tmp/pulled_content.txt
  register: verify_pull

- name: Assert pulled match
  assert:
    that:
      - "'content-data' in verify_pull.stdout"

- name: Delete file
  crystian.incus.incus_file:
    name: "test-file"
    remote: "{{ target_remote | default(omit) }}"
    dest: "/root/test_content.txt"
    state: absent
  register: delete_file

- name: Assert delete
  assert:
    that:
      - delete_file.changed == true

- name: Verify deleted
  crystian.incus.incus_exec:
    name: "test-file"
    remote: "{{ target_remote | default(omit) }}"
    command: "ls /root/test_content.txt"
  register: verify_delete
  ignore_errors: true

- name: Assert verification failed (file missing)
  assert:
    that:
      - verify_delete.rc != 0

- name: Cleanup (post-test)
  crystian.incus.incus_instance:
    name: "test-file"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    force: true

- name: Cleanup local files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/local_test_file.txt
    - /tmp/pulled_content.txt

- name: Create local directory structure
  file:
    path: /tmp/test_dir/subdir
    state: directory
    mode: '0755'

- name: Create test file in dir
  copy:
    content: "dir-content"
    dest: /tmp/test_dir/subdir/file.txt

- name: Push directory (recursive)
  crystian.incus.incus_file:
    name: "test-file"
    remote: "{{ target_remote | default(omit) }}"
    src: /tmp/test_dir/
    dest: /root/remote_dir/
    state: pushed
  register: push_dir
  ignore_errors: true

- name: Assert directory push
  assert:
    that:
      - push_dir.changed == true
      - push_dir.failed is not defined or not push_dir.failed
  when: push_dir is succeeded

- name: Update file permissions
  crystian.incus.incus_file:
    name: "test-file"
    remote: "{{ target_remote | default(omit) }}"
    dest: "/root/test_content.txt"
    content: "content-data"
    mode: '0600'
    state: pushed
  register: update_perms

- name: Assert permissions updated
  assert:
    that:
      - update_perms.changed == true

- name: Verify permissions
  crystian.incus.incus_exec:
    name: "test-file"
    remote: "{{ target_remote | default(omit) }}"
    command: "stat -c '%a' /root/test_content.txt"
  register: verify_perms

- name: Assert permission value
  assert:
    that:
      - "'600' in verify_perms.stdout"

- name: Cleanup directory test
  file:
    path: /tmp/test_dir
    state: absent

