- name: Get test-infra-vm IP
  crystian.incus.incus_list:
    filters:
      - test-infra-vm
  register: infra_info

- name: Set Infra IP
  set_fact:
    infra_ip: "{{ (infra_info.list | first).state.network | dict2items | map(attribute='value.addresses') | flatten | selectattr('family', 'equalto', 'inet') | map(attribute='address') | first }}"

- name: Generate Trust Token on test-infra-vm
  crystian.incus.incus_exec:
    instance_name: test-infra-vm
    command: incus config trust add test-client-remote --quiet
  register: infra_token

- name: Set Token
  set_fact:
    trust_token: "{{ infra_token.stdout | trim }}"

- name: Add Remote (test-remote-check)
  crystian.incus.incus_remote:
    name: "test-remote-check"
    url: "https://{{ infra_ip }}:8443"
    token: "{{ trust_token }}"
    accept_certificate: true
  register: remote_add

- name: Assert remote added
  assert:
    that:
      - remote_add.changed == true

- name: Verify remote operational
  crystian.incus.incus_list:
    remote: "test-remote-check"
  register: remote_check

- name: Assert remote works
  assert:
    that:
      - remote_check.changed == false

- name: Remove Remote
  crystian.incus.incus_remote:
    name: "test-remote-check"
    state: absent
