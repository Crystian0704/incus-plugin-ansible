- name: Cleanup image test
  crystian.incus.incus_image:
    alias: "test-alpine"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
  ignore_errors: true

- name: Copy remote image
  crystian.incus.incus_image:
    alias: "test-alpine"
    source: "images:alpine/edge"
    remote: "{{ target_remote | default(omit) }}"
    state: present
  register: img_copy

- name: Assert copy
  assert:
    that:
      - img_copy.changed == true

- name: Idempotency copy
  crystian.incus.incus_image:
    alias: "test-alpine"
    source: "images:alpine/edge"
    remote: "{{ target_remote | default(omit) }}"
    state: present
  register: img_copy_idemp

- name: Assert idempotency
  assert:
    that:
      - img_copy_idemp.changed == false

- name: Add alias to image
  crystian.incus.incus_image:
    alias: "test-alias-extra"
    source: "test-alpine"
    remote: "{{ target_remote | default(omit) }}"
    state: present
  register: img_alias

- name: Assert alias added
  assert:
    that:
      - img_alias.changed == true

- name: Ensure alias exists (verify)
  command: "incus image alias list {{ target_remote | default('local') }}:"
  register: alias_list

- name: Assert alias list
  assert:
    that:
      - "'test-alias-extra' in alias_list.stdout"

- name: Remove alias
  crystian.incus.incus_image:
    alias: "test-alias-extra"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
  register: img_alias_del

- name: Assert alias removed
  assert:
    that:
      - img_alias_del.changed == true


- name: Export image
  crystian.incus.incus_image:
    alias: "test-alpine"
    dest: "/tmp/exported_image"
    remote: "{{ target_remote | default(omit) }}"
    state: exported
  register: img_export

- name: Assert export
  assert:
    that:
      - img_export.changed == true

- name: Delete image
  crystian.incus.incus_image:
    alias: "test-alpine"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
  register: img_del

- name: Assert delete
  assert:
    that:
      - img_del.changed == true

- name: Import image from file
  crystian.incus.incus_image:
    alias: "test-alpine-imported"
    source: "/tmp/exported_image"
    remote: "{{ target_remote | default(omit) }}"
    state: present
  register: img_import

- name: Assert import
  assert:
    that:
      - img_import.changed == true

- name: Cleanup imported
  crystian.incus.incus_image:
    alias: "test-alpine-imported"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
  
- name: Cleanup file
  file:
    path: "/tmp/exported_image"
    state: absent
  ignore_errors: true
