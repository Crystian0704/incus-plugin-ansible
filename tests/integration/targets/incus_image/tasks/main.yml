- name: Cleanup image test
  crystian.incus.incus_image:
    alias: "test-alpine"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
  ignore_errors: true

- name: Copy remote image
  crystian.incus.incus_image:
    alias: "test-alpine"
    source: "images:alpine/edge"
    remote: "{{ target_remote | default(omit) }}"
    state: present
  register: img_copy

- name: Assert copy
  assert:
    that:
      - img_copy.changed == true

- name: Idempotency copy
  crystian.incus.incus_image:
    alias: "test-alpine"
    source: "images:alpine/edge"
    remote: "{{ target_remote | default(omit) }}"
    state: present
  register: img_copy_idemp

- name: Assert idempotency
  assert:
    that:
      - img_copy_idemp.changed == false

# ========================
# Properties tests
# ========================
- name: Set properties on existing image
  crystian.incus.incus_image:
    alias: "test-alpine"
    properties:
      os: "Alpine"
      release: "edge"
      custom.test: "value1"
    remote: "{{ target_remote | default(omit) }}"
    state: present
  register: img_props

- name: Assert properties changed
  assert:
    that:
      - img_props.changed == true

- name: Verify properties via CLI
  command: "incus image show {{ target_remote | default('local') }}:test-alpine"
  register: img_show

- name: Assert properties in show output
  assert:
    that:
      - "'os: Alpine' in img_show.stdout"
      - "'release: edge' in img_show.stdout"
      - "'custom.test: value1' in img_show.stdout"

- name: Idempotency properties (same values)
  crystian.incus.incus_image:
    alias: "test-alpine"
    properties:
      os: "Alpine"
      release: "edge"
      custom.test: "value1"
    remote: "{{ target_remote | default(omit) }}"
    state: present
  register: img_props_idemp

- name: Assert idempotency properties
  assert:
    that:
      - img_props_idemp.changed == false

- name: Update properties (declarative - removes custom.test)
  crystian.incus.incus_image:
    alias: "test-alpine"
    properties:
      os: "Alpine"
      release: "latest"
    remote: "{{ target_remote | default(omit) }}"
    state: present
  register: img_props_upd

- name: Assert properties updated
  assert:
    that:
      - img_props_upd.changed == true

- name: Verify updated properties via CLI
  command: "incus image show {{ target_remote | default('local') }}:test-alpine"
  register: img_show_upd

- name: Assert updated properties
  assert:
    that:
      - "'release: latest' in img_show_upd.stdout"
      - "'custom.test' not in img_show_upd.stdout"

- name: Export image
  crystian.incus.incus_image:
    alias: "test-alpine"
    dest: "/tmp/exported_image"
    remote: "{{ target_remote | default(omit) }}"
    state: exported
  register: img_export

- name: Assert export
  assert:
    that:
      - img_export.changed == true

- name: Add alias to image
  crystian.incus.incus_image:
    alias: "test-alpine"
    aliases: ["test-alias-extra"]
    remote: "{{ target_remote | default(omit) }}"
    state: present
  register: img_alias

- name: Assert alias added
  assert:
    that:
      - img_alias.changed == true

- name: Ensure alias exists (verify)
  command: "incus image alias list {{ target_remote | default('local') }}:"
  register: alias_list

- name: Assert alias list
  assert:
    that:
      - "'test-alias-extra' in alias_list.stdout"

- name: Remove alias
  crystian.incus.incus_image:
    alias: "test-alias-extra"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
  register: img_alias_del

- name: Assert alias removed
  assert:
    that:
      - img_alias_del.changed == true

- name: Ensure image exists for refresh test
  crystian.incus.incus_image:
    alias: "test-alpine"
    source: "images:alpine/edge"
    remote: "{{ target_remote | default(omit) }}"
    state: present

# === REFRESH TESTS ===
- name: Refresh image (idempotent if no update)
  crystian.incus.incus_image:
    alias: "test-alpine"
    refresh: true
    remote: "{{ target_remote | default(omit) }}"
    state: present
  register: img_refresh

- name: Assert refresh idempotent
  assert:
    that:
      - img_refresh.changed == false

- name: Cleanup remote copy
  crystian.incus.incus_image:
    alias: "test-alpine"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
  ignore_errors: true

- name: Import image from file
  crystian.incus.incus_image:
    alias: "test-alpine-imported"
    source: "/tmp/exported_image"
    remote: "{{ target_remote | default(omit) }}"
    state: present
  register: img_import

- name: Assert import
  assert:
    that:
      - img_import.changed == true

- name: Cleanup imported
  crystian.incus.incus_image:
    alias: "test-alpine-imported"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
  
- name: Cleanup file
  file:
    path: "/tmp/exported_image"
    state: absent
  ignore_errors: true

# === INFO TESTS ===
- name: Ensure test-image exists for info tests
  crystian.incus.incus_image:
    alias: "test-info-alpine"
    source: "images:alpine/edge"
    remote: "{{ target_remote | default(omit) }}"
    state: present

- name: Retrieve info for specific image by alias
  crystian.incus.incus_image:
    alias: "test-info-alpine"
    remote: "{{ target_remote | default(omit) }}"
    state: info
  register: img_info_specific

- name: Assert specific image info retrieved
  assert:
    that:
      - img_info_specific.changed == false
      - img_info_specific.images is defined
      - img_info_specific.images | length == 1
      - "('test-info-alpine' in img_info_specific.images[0].aliases | map(attribute='name') | list) or (img_info_specific.images[0].aliases | length == 0)"  # Just to ensure we got some data, incus aliases structure check

- name: Retrieve info for all images
  crystian.incus.incus_image:
    remote: "{{ target_remote | default(omit) }}"
    state: info
  register: img_info_all

- name: Assert all images info retrieved
  assert:
    that:
      - img_info_all.changed == false
      - img_info_all.images is defined
      - img_info_all.images | length >= 1

- name: Cleanup test image used for info
  crystian.incus.incus_image:
    alias: "test-info-alpine"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
  ignore_errors: true
