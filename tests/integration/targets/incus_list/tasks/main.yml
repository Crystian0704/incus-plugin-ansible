---
- name: List all local instances
  crystian.incus.incus_list:
    remote: "{{ target_remote | default(omit) }}"
  register: result_all

- name: Verify list structure
  assert:
    that:
      - result_all.changed == false
      - "'list' in result_all"
      - result_all.list is sequence

- name: Setup container for list test
  crystian.incus.incus_instance:
    name: list-test-ct
    remote: "{{ target_remote | default(omit) }}"
    remote_image: images:alpine/edge
    started: true

- name: Setup VM for list test
  crystian.incus.incus_instance:
    name: list-test-vm
    remote: "{{ target_remote | default(omit) }}"
    remote_image: images:alpine/edge
    vm: true
    started: false
    config:

       security.secureboot: "false"

- name: Setup project for list test
  crystian.incus.incus_project:
    name: "list-project"
    remote: "{{ target_remote | default(omit) }}"
    config:
      features.images: "false"
      features.profiles: "false"
    state: present

- name: Setup instance in project
  crystian.incus.incus_instance:
    name: "list-test-project-ct"
    project: "list-project"
    remote: "{{ target_remote | default(omit) }}"
    remote_image: "images:alpine/edge"
    started: true

- name: List with project filter
  crystian.incus.incus_list:
    remote: "{{ target_remote | default(omit) }}"
    project: "list-project"
  register: result_project

- name: Verify project filter
  assert:
    that:
      - result_project.list | length == 1
      - result_project.list[0].name == "list-test-project-ct"


- name: List with status filter (Running)
  crystian.incus.incus_list:
    remote: "{{ target_remote | default(omit) }}"
    filters:
      - status=Running
  register: result_running

- name: Verify status filter
  assert:
    that:
      - result_running.list | length >= 1
      - result_running.list | selectattr('name', 'equalto', 'list-test-ct') | list | length == 1
      - result_running.list | selectattr('name', 'equalto', 'list-test-vm') | list | length == 0

- name: List with type filter (virtual-machine)
  crystian.incus.incus_list:
    remote: "{{ target_remote | default(omit) }}"
    filters:
      - type=virtual-machine
  register: result_vm

- name: Verify type filter
  assert:
    that:
      - result_vm.list | length >= 1
      - result_vm.list | selectattr('name', 'equalto', 'list-test-vm') | list | length == 1

- name: Test incus_list remote (explicit)
  crystian.incus.incus_list:
    remote: "{{ target_remote | default(omit) }}"
  register: result_remote

- name: Verify remote list
  assert:
    that:
      - result_remote.changed == false
      - result_remote.list is sequence

- name: Test incus_list all_remotes
  crystian.incus.incus_list:
    all_remotes: true
  register: result_all_remotes

- name: Verify all_remotes list
  assert:
    that:
      - result_all_remotes.list | length >= 2
      - result_all_remotes.list | selectattr('name', 'equalto', 'list-test-ct') | list | length == 1
      - (result_all_remotes.list | selectattr('name', 'equalto', 'list-test-ct') | first).location == (target_remote | default('local'))

- name: Cleanup list tests
  crystian.incus.incus_instance:
    name: "{{ item }}"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    force: true
  loop:
    - list-test-ct
    - list-test-vm

- name: Cleanup project instance
  crystian.incus.incus_instance:
    name: "list-test-project-ct"
    project: "list-project"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    force: true
  ignore_errors: true

- name: Cleanup project
  crystian.incus.incus_project:
    name: "list-project"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
  ignore_errors: true
