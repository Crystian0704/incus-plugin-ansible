---
- name: Cleanup instance test (using module)
  crystian.incus.incus_instance:
    name: "{{ item }}"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    force: true
  loop:
    - test-ansible-init
    - test-ansible-launch
    - test-ansible-renamed
    - ct1
    - test-complex-container
    - test-complex-vm
    - instance-to-delete
    - instance-running-delete
    - test-restart
    - test-freeze
    - test-rebuild
    - test-profile-inst
  ignore_errors: true

- name: Test incus_instance with tags
  crystian.incus.incus_instance:
    name: test-tags
    remote_image: images:alpine/edge
    remote: "{{ target_remote | default(omit) }}"
    tags:
      env: production
      role: backend
    started: true
  register: result_tags

- name: Verify tags creation
  assert:
    that:
      - result_tags.changed == true
      - result_tags.instance.config['user.env'] == "production"
      - result_tags.instance.config['user.role'] == "backend"

- name: Update tags via incus_config
  crystian.incus.incus_config:
    instance_name: test-tags
    remote: "{{ target_remote | default(omit) }}"
    tags:
      role: frontend
      owner: me
    state: present
  register: result_tags_update

- name: Verify tags update
  crystian.incus.incus_info:
    name: test-tags
    remote: "{{ target_remote | default(omit) }}"
  register: info_tags

- name: Assert updated tags
  assert:
    that:
      - result_tags_update.changed == true
      - info_tags.info.config['user.env'] == "production"
      - info_tags.info.config['user.role'] == "frontend"
      - info_tags.info.config['user.owner'] == "me"

- name: Remove tags via incus_config
  crystian.incus.incus_config:
    instance_name: test-tags
    remote: "{{ target_remote | default(omit) }}"
    tags:
      owner: null
    state: absent
  register: result_tags_remove

- name: Verify tags removal
  crystian.incus.incus_info:
    name: test-tags
    remote: "{{ target_remote | default(omit) }}"
  register: info_tags_removed

- name: Assert removed tags
  assert:
    that:
      - result_tags_remove.changed == true
      - "'user.owner' not in info_tags_removed.info.config"
      - info_tags_removed.info.config['user.role'] == "frontend"

- name: Cleanup tags test
  crystian.incus.incus_instance:
    name: test-tags
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    force: true

- name: Test incus_instance (init behavior - stopped)
  crystian.incus.incus_instance:
    name: test-ansible-init
    remote_image: images:alpine/edge
    remote: "{{ target_remote | default(omit) }}"
    started: false
  register: result_init

- name: Verify init result
  assert:
    that:
      - result_init.changed == true
      - result_init.instance.status == "Stopped"

- name: Test incus_instance idempotency (init)
  crystian.incus.incus_instance:
    name: test-ansible-init
    remote_image: images:alpine/edge
    remote: "{{ target_remote | default(omit) }}"
    started: false
  register: result_init_idempotency

- name: Verify init idempotency
  assert:
    that:
      - result_init_idempotency.changed == false

- name: Test incus_instance (launch behavior - running)
  crystian.incus.incus_instance:
    name: test-ansible-launch
    remote_image: images:alpine/edge
    remote: "{{ target_remote | default(omit) }}"
    started: true
  register: result_launch

- name: Verify launch result
  assert:
    that:
      - result_launch.changed == true
      - result_launch.instance.status == "Running"
      - "'state' in result_launch"
      - "'cpu' in result_launch.state"

- name: Test incus_instance idempotency (launch)
  crystian.incus.incus_instance:
    name: test-ansible-launch
    remote_image: images:alpine/edge
    remote: "{{ target_remote | default(omit) }}"
    started: true
  register: result_launch_idempotency

- name: Verify launch idempotency
  assert:
    that:
      - result_launch_idempotency.changed == false

- name: Test state change (start init-ed instance)
  crystian.incus.incus_instance:
    name: test-ansible-init
    remote_image: images:alpine/edge
    remote: "{{ target_remote | default(omit) }}"
    started: true
  register: result_start

- name: Verify state change
  assert:
    that:
      - result_start.instance.status == "Running"

- name: Test config update on running instance
  crystian.incus.incus_instance:
    name: test-ansible-init
    remote: "{{ target_remote | default(omit) }}"
    config:
      limits.cpu: "1"
    state: present
  register: result_config_update

- name: Verify config update
  assert:
    that:
      - result_config_update.changed == true
      - result_config_update.instance.config['limits.cpu'] == "1"

- name: Stop instance before rename
  crystian.incus.incus_instance:
    name: test-ansible-init
    remote: "{{ target_remote | default(omit) }}"
    state: present
    started: false

- name: Rename instance
  crystian.incus.incus_instance:
    name: test-ansible-renamed
    rename_from: test-ansible-init
    remote: "{{ target_remote | default(omit) }}"
    state: present
  register: result_rename

- name: Verify rename
  assert:
    that:
      - result_rename.changed == true
      - result_rename.instance.name == "test-ansible-renamed"

- name: Create snapshot for restore test
  crystian.incus.incus_snapshot:
    instance_name: test-ansible-renamed
    snapshot_name: snap0
    remote: "{{ target_remote | default(omit) }}"
    state: present

- name: Change state (to be reverted)
  crystian.incus.incus_instance:
    name: test-ansible-renamed
    remote: "{{ target_remote | default(omit) }}"
    config:
      limits.cpu: "2"
    state: present

- name: Restore from snapshot (using instance module if supported, or snapshot module)
  crystian.incus.incus_snapshot:
    instance_name: test-ansible-renamed
    snapshot_name: snap0
    remote: "{{ target_remote | default(omit) }}"
    state: restored
  register: result_restore

- name: Verify restore (cpu limit back to 1)
  crystian.incus.incus_instance:
    name: test-ansible-renamed
    remote: "{{ target_remote | default(omit) }}"
    state: present
  register: result_after_restore

- name: Assert restored config
  assert:
    that:
      - result_after_restore.instance.config['limits.cpu'] == "1"

- name: Cleanup renamed
  crystian.incus.incus_instance:
    name: test-ansible-renamed
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    force: true

- name: Cleanup tests
  crystian.incus.incus_instance:
    name: "{{ item }}"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    force: true
  loop:
    - test-ansible-init
    - test-ansible-launch

- name: Test incus_instance (remote target)
  crystian.incus.incus_instance:
    name: ct1
    remote: "{{ target_remote | default('local') }}"
    remote_image: images:debian/13
    started: true
  register: result_remote

- name: Verify remote launch result
  assert:
    that:
      - result_remote.changed == true
      - result_remote.instance.status == "Running"
      - result_remote.instance.name == "ct1"

- name: Cleanup remote test
  crystian.incus.incus_instance:
    name: ct1
    remote: "{{ target_remote | default('local') }}"
    state: absent
    force: true


- name: Create storage volume for test
  crystian.incus.incus_storage_volume:
    pool: default
    name: testvol
    remote: "{{ target_remote | default(omit) }}"
    type: filesystem
    state: present

- name: Test incus_instance (Complex Container)
  crystian.incus.incus_instance:
    name: test-complex-container
    remote_image: images:alpine/edge
    remote: "{{ target_remote | default(omit) }}"
    started: true
    description: "Complex container test"
    storage: default
    network: incusbr0
    config:
      limits.cpu: "1"
      limits.memory: "128MiB"
    devices:
      testvol:
        path: /opt/testvol
        pool: default
        source: testvol
        type: disk
  register: result_complex_container

- name: Verify complex container
  assert:
    that:
      - result_complex_container.changed == true
      - result_complex_container.instance.status == "Running"
      - result_complex_container.instance.config['limits.cpu'] == "1"
      - result_complex_container.instance.description == "Complex container test"
      - "'testvol' in result_complex_container.instance.devices"

- name: Test incus_instance (Complex VM)
  crystian.incus.incus_instance:
    name: test-complex-vm
    remote_image: images:alpine/edge
    remote: "{{ target_remote | default(omit) }}"
    vm: true
    started: true
    storage: default
    network: incusbr0
    config:
      limits.cpu: "2"
      limits.memory: "1GiB"
      security.secureboot: "false"
  register: result_complex_vm

- name: Verify complex VM
  assert:
    that:
      - result_complex_vm.changed == true
      - result_complex_vm.instance.status == "Running"
      - result_complex_vm.instance.type == "virtual-machine"
      - result_complex_vm.instance.config['limits.cpu'] == "2"

- name: Cleanup complex tests
  crystian.incus.incus_instance:
    name: "{{ item }}"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    force: true
  loop:
    - test-complex-container
    - test-complex-vm

- name: Cleanup test volume
  crystian.incus.incus_storage_volume:
    pool: default
    name: testvol
    remote: "{{ target_remote | default(omit) }}"
    state: absent

- name: Create instance for delete test
  crystian.incus.incus_instance:
    name: instance-to-delete
    remote_image: images:alpine/edge
    remote: "{{ target_remote | default(omit) }}"
    started: false

- name: "Delete stopped instance (state: absent)"
  crystian.incus.incus_instance:
    name: instance-to-delete
    remote_image: images:alpine/edge
    remote: "{{ target_remote | default(omit) }}"
    state: absent
  register: result_delete_stopped

- name: Verify delete
  assert:
    that:
      - result_delete_stopped.changed == true

- name: Create running instance for force delete
  crystian.incus.incus_instance:
    name: instance-running-delete
    remote_image: images:alpine/edge
    remote: "{{ target_remote | default(omit) }}"
    started: true

- name: Delete running instance (should fail without force)
  crystian.incus.incus_instance:
    name: instance-running-delete
    remote_image: images:alpine/edge
    remote: "{{ target_remote | default(omit) }}"
    state: absent
  register: result_delete_fail
  ignore_errors: true

- name: Verify delete failure
  assert:
    that:
      - result_delete_fail.failed == true

- name: Force delete running instance
  crystian.incus.incus_instance:
    name: instance-running-delete
    remote_image: images:alpine/edge
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    force: true
  register: result_force_delete

- name: Verify force delete
  assert:
    that:
      - result_force_delete.changed == true

- name: Verify idempotency (delete non-existent)
  crystian.incus.incus_instance:
    name: instance-to-delete
    remote_image: images:alpine/edge
    remote: "{{ target_remote | default(omit) }}"
    state: absent
  register: result_delete_idempotency

- name: Verify delete idempotency
  assert:
    that:
      - result_delete_idempotency.changed == false

# === RESTART TESTS ===
- name: Create instance for restart tests
  crystian.incus.incus_instance:
    name: test-restart
    remote_image: images:alpine/edge
    remote: "{{ target_remote | default(omit) }}"
    started: true

- name: Restart running instance
  crystian.incus.incus_instance:
    name: test-restart
    remote: "{{ target_remote | default(omit) }}"
    state: restarted
  register: result_restart

- name: Verify restart
  assert:
    that:
      - result_restart.changed == true
      - result_restart.instance.status == "Running"

- name: Stop instance for restart-from-stopped test
  crystian.incus.incus_instance:
    name: test-restart
    remote: "{{ target_remote | default(omit) }}"
    started: false
    state: present

- name: Restart stopped instance (should start it)
  crystian.incus.incus_instance:
    name: test-restart
    remote: "{{ target_remote | default(omit) }}"
    state: restarted
  register: result_restart_stopped

- name: Verify restart from stopped starts it
  assert:
    that:
      - result_restart_stopped.changed == true
      - result_restart_stopped.instance.status == "Running"

- name: Force restart running instance
  crystian.incus.incus_instance:
    name: test-restart
    remote: "{{ target_remote | default(omit) }}"
    state: restarted
    force: true
    timeout: 30
  register: result_force_restart

- name: Verify force restart
  assert:
    that:
      - result_force_restart.changed == true

- name: Restart non-existent instance (should fail)
  crystian.incus.incus_instance:
    name: non-existent-restart-test
    remote: "{{ target_remote | default(omit) }}"
    state: restarted
  register: result_restart_fail
  ignore_errors: true

- name: Verify restart fail
  assert:
    that:
      - result_restart_fail is failed
      - "'not found' in result_restart_fail.msg"

# === FREEZE / UNFREEZE TESTS ===
- name: Freeze running instance
  crystian.incus.incus_instance:
    name: test-restart
    remote: "{{ target_remote | default(omit) }}"
    state: frozen
  register: result_freeze

- name: Verify freeze
  assert:
    that:
      - result_freeze.changed == true

- name: Freeze already frozen instance (idempotent)
  crystian.incus.incus_instance:
    name: test-restart
    remote: "{{ target_remote | default(omit) }}"
    state: frozen
  register: result_freeze_idempotent

- name: Verify freeze idempotent
  assert:
    that:
      - result_freeze_idempotent.changed == false

- name: Unfreeze frozen instance
  crystian.incus.incus_instance:
    name: test-restart
    remote: "{{ target_remote | default(omit) }}"
    state: unfrozen
  register: result_unfreeze

- name: Verify unfreeze
  assert:
    that:
      - result_unfreeze.changed == true
      - result_unfreeze.instance.status == "Running"

- name: Unfreeze already running instance (idempotent)
  crystian.incus.incus_instance:
    name: test-restart
    remote: "{{ target_remote | default(omit) }}"
    state: unfrozen
  register: result_unfreeze_idempotent

- name: Verify unfreeze idempotent
  assert:
    that:
      - result_unfreeze_idempotent.changed == false

- name: Stop instance then try freeze (should fail)
  crystian.incus.incus_instance:
    name: test-restart
    remote: "{{ target_remote | default(omit) }}"
    started: false
    state: present

- name: Freeze stopped instance (should fail)
  crystian.incus.incus_instance:
    name: test-restart
    remote: "{{ target_remote | default(omit) }}"
    state: frozen
  register: result_freeze_stopped
  ignore_errors: true

- name: Verify freeze stopped fails
  assert:
    that:
      - result_freeze_stopped is failed
      - "'must be running' in result_freeze_stopped.msg"

# === REBUILD TESTS ===
- name: Create instance for rebuild tests
  crystian.incus.incus_instance:
    name: test-rebuild
    remote_image: images:alpine/edge
    remote: "{{ target_remote | default(omit) }}"
    started: false

- name: Rebuild with new image (stopped)
  crystian.incus.incus_instance:
    name: test-rebuild
    remote: "{{ target_remote | default(omit) }}"
    state: rebuilt
    rebuild_image: images:alpine/edge
  register: result_rebuild

- name: Verify rebuild
  assert:
    that:
      - result_rebuild.changed == true

- name: Start and rebuild with force
  crystian.incus.incus_instance:
    name: test-rebuild
    remote: "{{ target_remote | default(omit) }}"
    started: true
    state: present

- name: Rebuild running instance with force
  crystian.incus.incus_instance:
    name: test-rebuild
    remote: "{{ target_remote | default(omit) }}"
    state: rebuilt
    rebuild_image: images:alpine/edge
    force: true
  register: result_rebuild_force

- name: Verify rebuild force
  assert:
    that:
      - result_rebuild_force.changed == true

- name: Rebuild as empty (stopped)
  crystian.incus.incus_instance:
    name: test-rebuild
    remote: "{{ target_remote | default(omit) }}"
    started: false
    state: present

- name: Rebuild empty
  crystian.incus.incus_instance:
    name: test-rebuild
    remote: "{{ target_remote | default(omit) }}"
    state: rebuilt
  register: result_rebuild_empty

- name: Verify rebuild empty
  assert:
    that:
      - result_rebuild_empty.changed == true

- name: Rebuild non-existent instance (should fail)
  crystian.incus.incus_instance:
    name: non-existent-rebuild-test
    remote: "{{ target_remote | default(omit) }}"
    state: rebuilt
    rebuild_image: images:alpine/edge
  register: result_rebuild_fail
  ignore_errors: true

- name: Verify rebuild fail
  assert:
    that:
      - result_rebuild_fail is failed
      - "'not found' in result_rebuild_fail.msg"

# === CLEANUP ===
- name: Cleanup restart test instance
  crystian.incus.incus_instance:
    name: test-restart
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    force: true
  ignore_errors: true

- name: Cleanup rebuild test instance
  crystian.incus.incus_instance:
    name: test-rebuild
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    force: true
  ignore_errors: true

# === PROFILE TESTS ===
- name: Create test profile
  crystian.incus.incus_profile:
    name: test-prof
    config:
      user.foo: bar
    state: present
    remote: "{{ target_remote | default(omit) }}"

- name: Create instance with default profile
  crystian.incus.incus_instance:
    name: test-profile-inst
    remote_image: images:alpine/edge
    remote: "{{ target_remote | default(omit) }}"
    profiles: [default]
    state: present
    started: false

- name: Add profile to instance
  crystian.incus.incus_instance:
    name: test-profile-inst
    remote: "{{ target_remote | default(omit) }}"
    profiles: [default, test-prof]
    state: present
  register: result_prof_add

- name: Verify profile add
  assert:
    that:
      - result_prof_add.changed == true

- name: Verify profile content
  set_fact:
    inst_info: "{{ query('crystian.incus.incus_query', '/1.0/instances/test-profile-inst', remote=(target_remote | default('local'))) | first }}"

- name: Assert profile applied
  assert:
    that:
      - "'test-prof' in inst_info.profiles"
      - "'default' in inst_info.profiles"

- name: Add profile idempotent
  crystian.incus.incus_instance:
    name: test-profile-inst
    remote: "{{ target_remote | default(omit) }}"
    profiles: [default, test-prof]
    state: present
  register: result_prof_idem

- name: Verify profile idempotent
  assert:
    that:
      - result_prof_idem.changed == false

- name: Remove profile from instance
  crystian.incus.incus_instance:
    name: test-profile-inst
    remote: "{{ target_remote | default(omit) }}"
    profiles: [default]
    state: present
  register: result_prof_remove

- name: Verify profile remove
  assert:
    that:
      - result_prof_remove.changed == true

- name: Remove all profiles (empty list)
  crystian.incus.incus_instance:
    name: test-profile-inst
    remote: "{{ target_remote | default(omit) }}"
    profiles: []
    state: present
  register: result_prof_empty

- name: Verify profile empty
  assert:
    that:
      - result_prof_empty.changed == true

# Cleanup
- name: Cleanup profile instance
  crystian.incus.incus_instance:
    name: test-profile-inst
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    force: true
  ignore_errors: true

- name: Cleanup test profile
  crystian.incus.incus_profile:
    name: test-prof
    remote: "{{ target_remote | default(omit) }}"
    state: absent
  ignore_errors: true
