- name: Cleanup (pre-test)
  crystian.incus.incus_instance:
    name: "test-exec"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    force: true
  ignore_errors: true

- name: Create test instance
  crystian.incus.incus_instance:
    name: "test-exec"
    remote: "{{ target_remote | default(omit) }}"
    remote_image: "images:alpine/edge/cloud"
    started: true

- name: Wait for instance to be ready
  pause:
    seconds: 5

- name: Simple command execution
  crystian.incus.incus_exec:
    name: "test-exec"
    remote: "{{ target_remote | default(omit) }}"
    command: "echo hello world"
  register: exec_simple

- name: Assert simple command
  assert:
    that:
      - exec_simple.rc == 0
      - "'hello world' in exec_simple.stdout"

- name: List command execution
  crystian.incus.incus_exec:
    name: "test-exec"
    remote: "{{ target_remote | default(omit) }}"
    command: ['echo', 'list', 'args']
  register: exec_list

- name: Assert list command
  assert:
    that:
      - exec_list.rc == 0
      - "'list args' in exec_list.stdout"

- name: Env var execution
  crystian.incus.incus_exec:
    name: "test-exec"
    remote: "{{ target_remote | default(omit) }}"
    command: "env"
    env:
      TEST_VAR: "my_value"
  register: exec_env

- name: Assert env var
  assert:
    that:
      - exec_env.rc == 0
      - "'TEST_VAR=my_value' in exec_env.stdout"

- name: CWD execution
  crystian.incus.incus_exec:
    name: "test-exec"
    remote: "{{ target_remote | default(omit) }}"
    command: "pwd"
    cwd: "/tmp"
  register: exec_cwd

- name: Assert cwd
  assert:
    that:
      - exec_cwd.rc == 0
      - "'/tmp' in exec_cwd.stdout"

    state: absent
    force: true

- name: Create test instance for failure test
  crystian.incus.incus_instance:
    name: "test-exec-fail"
    remote: "{{ target_remote | default(omit) }}"
    remote_image: "images:alpine/edge/cloud"
    started: true

- name: Wait for instance (fail test)
  pause:
    seconds: 5

- name: Execute failing command
  crystian.incus.incus_exec:
    name: "test-exec-fail"
    remote: "{{ target_remote | default(omit) }}"
    command: "ls /nonexistent"
  register: exec_fail
  ignore_errors: true

- name: Assert failing command
  assert:
    that:
      - exec_fail.failed == true
      - exec_fail.rc != 0
      - "'No such file' in exec_fail.stderr or 'not found' in exec_fail.stderr"

- name: Cleanup (post-fail-test)
  crystian.incus.incus_instance:
    name: "test-exec-fail"
    remote: "{{ target_remote | default(omit) }}"
    state: absent
    force: true
