---
- name: Test Lookup Plugins
  hosts: localhost
  connection: local
  gather_facts: false
  
  tasks:
    - name: Info | Get test-infra-vm details
      debug:
        msg: "{{ lookup('crystian.incus.incus_info', 'test-infra-vm') }}"
      register: info_result

    - name: Info | Verify result
      assert:
        that:
          - info_result.msg.name == 'test-infra-vm'
          - info_result.msg.state_info.status == 'Running'

    - name: Config | Get test-infra-vm config
      debug:
        msg: "{{ lookup('crystian.incus.incus_config', 'test-infra-vm') }}"
      register: config_result
      
    - name: Config | Verify result
      assert:
        that:
          - config_result.msg.name == 'test-infra-vm'
          - "'expanded_devices' in config_result.msg"
          
    - name: List | Get all instances
      debug:
        msg: "{{ lookup('crystian.incus.incus_list') }}"
      register: list_result
      
    - name: List | Verify result
      assert:
        that:
          - list_result.msg | length > 0
          - list_result.msg[0].name is defined

    - name: List | Filter by name
      debug:
        msg: "{{ lookup('crystian.incus.incus_list', filters=['test-infra-vm']) }}"
      register: list_filter_result
      
    - name: List | Verify filter result
      assert:
        that:
          - list_filter_result.msg | length == 1
          - list_filter_result.msg[0].name == 'test-infra-vm'

