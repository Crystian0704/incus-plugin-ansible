---
- name: Provision Test Infrastructure (Localhost)
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    vm_name: "test-infra-vm"
    remote_name: "test-infra"
    image_name: "images:debian/13"

  tasks:

    - name: Check for existing snapshot
      crystian.incus.incus_info:
        name: "{{ vm_name }}"
      register: vm_info
      ignore_errors: true

    - name: Set Setup Strategy
      set_fact:
        do_restore: >-
          {{
            (force_restore | default(false) | bool) or
            (
              (not (force_cleanup | default(false) | bool)) and
              (not vm_info.failed) and
              ('base-setup' in (vm_info.info.snapshots | default([])))
            )
          }}

    - name: Cleanup previous infra (Force Cleanup or Rebuild)
      block:
        - name: Remove VM
          crystian.incus.incus_instance:
            name: "{{ vm_name }}"
            state: absent
            force: true
          ignore_errors: true
          when: not do_restore

        - name: Remove Remote
          crystian.incus.incus_remote:
            name: "{{ remote_name }}"
            state: absent
          ignore_errors: true


    - name: Restore base-setup snapshot
      crystian.incus.incus_snapshot:
        instance_name: "{{ vm_name }}"
        snapshot_name: base-setup
        state: restored
      when: do_restore
      register: restore_result

    - name: Ensure VM is started (Restored)
      crystian.incus.incus_instance:
        name: "{{ vm_name }}"
        state: present
        started: true
      when: do_restore

    - name: Create Test VM (Debian 13)
      crystian.incus.incus_instance:
        name: "{{ vm_name }}"
        remote_image: "{{ image_name }}"
        vm: true
        config:
          limits.cpu: "2"
          limits.memory: "2GiB"
          security.secureboot: "false"
        started: true
        state: present
      when: not do_restore
      register: create_vm

    - name: Restart VM to apply config (Secure Boot)
      crystian.incus.incus_instance:
        name: "{{ vm_name }}"
        state: restarted
        force: true
      when: 
        - not do_restore
        - create_vm.changed

    - name: Wait for VM Agent
      crystian.incus.incus_exec:
        name: "{{ vm_name }}"
        command: "true"
      register: agent_check
      until: agent_check.rc == 0
      retries: 60
      delay: 2
      changed_when: false
      ignore_errors: true

    - name: Get VM IP
      set_fact:
         vm_ip: "{{ query('crystian.incus.incus_list', vm_name) | map(attribute='state.network') | list | first | dict2items | map(attribute='value.addresses') | flatten | selectattr('family', 'equalto', 'inet') | map(attribute='address') | first }}"

    - name: Add host to inventory
      add_host:
        name: "{{ vm_name }}"
        groups: build_group
        ansible_connection: community.general.incus
        ansible_incus_remote: local
        ansible_user: root
        ansible_remote_tmp: /tmp
        # Persist strategy to next plays
        setup_strategy_restore: "{{ do_restore }}"


- name: Configure Test Infrastructure (VM Inside)
  hosts: build_group
  gather_facts: false
  tasks:
    - name: Run Configuration Tasks
      when: not hostvars['localhost']['do_restore'] | bool
      block:
        - name: Install Python (raw)
          raw: apt-get update && apt-get install -y python3
          changed_when: false

        - name: Gather Facts
          setup:

        - name: Install Kernel and ZFS dependencies
          apt:
            name:
              - ca-certificates
              - curl
              - gnupg
              - lvm2
              - btrfs-progs
              - python3-yaml
              - zfsutils-linux
              - zfs-dkms
              - linux-headers-amd64
              - linux-image-amd64
              - qemu-guest-agent
            state: latest
            update_cache: yes
          register: kernel_install

        - name: Reboot if Kernel/ZFS updated
          reboot:
            msg: "Rebooting to activate new kernel/ZFS"
            connect_timeout: 5
            reboot_timeout: 300
            pre_reboot_delay: 0
            post_reboot_delay: 30
            test_command: whoami
          when: kernel_install.changed

        - name: Gather Facts again
          setup:
          when: kernel_install.changed

        - name: Create Keyrings Dir
          file:
            path: /etc/apt/keyrings
            state: directory
            mode: '0755'

        - name: Download Zabbly Key
          get_url:
            url: https://pkgs.zabbly.com/key.asc
            dest: /etc/apt/keyrings/zabbly.asc
            mode: '0644'

        - name: Add Zabbly Repository
          apt_repository:
            repo: "deb [signed-by=/etc/apt/keyrings/zabbly.asc] https://pkgs.zabbly.com/incus/daily trixie main"
            filename: zabbly-incus-daily
            state: present
            update_cache: yes

        - name: Install Incus
          apt:
            name: incus
            state: present
            update_cache: yes

        - name: Start Incus Service
          service:
            name: incus
            state: started
            enabled: yes

        - name: Initialize Incus (Minimal)
          crystian.incus.incus_admin_init:
            minimal: true

        - name: Config bind address
          crystian.incus.incus_config:
            config:
              core.https_address: ":8443"

        - name: Install OVN dependencies
          apt:
            name:
              - ovn-host
              - ovn-central
              - openvswitch-switch
            state: present

        - name: Configure OVS for OVN
          command: "ovs-vsctl set open_vswitch . external_ids:ovn-remote=unix:/run/ovn/ovnsb_db.sock external_ids:ovn-encap-type=geneve external_ids:ovn-encap-ip=127.0.0.1"

        - name: Enable OVN services
          service:
            name: "{{ item }}"
            state: started
            enabled: yes
          loop:
            - ovn-central
            - ovn-host

        - name: Configure Incus OVN connection
          crystian.incus.incus_config:
            config:
              network.ovn.northbound_connection: "unix:/run/ovn/ovnnb_db.sock"

    - name: Reset Trust Token (Always)
      block:
        - name: Remove existing trust token
          crystian.incus.incus_config:
            trust:
              name: ansible-client
            state: absent

        - name: Create trust token
          crystian.incus.incus_config:
            trust:
              name: ansible-client
            state: present
          register: trust_token_generated



- name: Finalize Setup (Localhost)
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    vm_name: "test-infra-vm"
    remote_name: "test-infra"

  tasks:
    - name: Set Final Token
      set_fact:
        final_trust_token: "{{ hostvars[vm_name]['trust_token_generated']['token'] }}"

    - name: Add Remote
      crystian.incus.incus_remote:
        name: "{{ remote_name }}"
        url: "https://{{ vm_ip }}:8443"
        token: "{{ final_trust_token }}"
        accept_certificate: true

    - name: Create Nested Resources
      when: not do_restore | bool
      block:
        - name: Create incusbr0 network (nested)
          crystian.incus.incus_network:
             name: incusbr0
             type: bridge
             remote: "{{ remote_name }}"
             state: present

        - name: Create default storage pool (nested)
          crystian.incus.incus_storage:
            name: default
            driver: dir
            remote: "{{ remote_name }}"
            state: present

        - name: Create default profile root disk (nested)
          crystian.incus.incus_profile:
            name: default
            remote: "{{ remote_name }}"
            devices:
              root:
                path: /
                pool: default
                type: disk
              eth0:
                name: eth0
                network: incusbr0
                type: nic
            state: present

    - name: Prepare VM for clean snapshot (Stop)
      crystian.incus.incus_instance:
        name: "{{ vm_name }}"
        state: present
        started: false
      when: not do_restore | bool

    - name: Create base-setup snapshot
      crystian.incus.incus_snapshot:
        instance_name: "{{ vm_name }}"
        snapshot_name: base-setup
        state: present
      when: not do_restore | bool

    - name: Start VM again
      crystian.incus.incus_instance:
        name: "{{ vm_name }}"
        state: present
        started: true
      when: not do_restore | bool

    - name: Pause to allow trust propagation & VM boot
      pause:
        seconds: 10
