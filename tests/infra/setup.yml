---
- hosts: localhost
  connection: local
  gather_facts: false
  vars:
    vm_name: "test-infra-vm"
    remote_name: "test-infra"
    image_name: "images:debian/13"

  tasks:
    - name: Check for setup marker
      stat:
        path: .test_setup_complete
      register: setup_marker

    - name: End play if setup is complete
      meta: end_play
      when:
        - false # FORCE RUN # - setup_marker.stat.exists
        - not (delete_infra | default(false) | bool)

    - name: Cleanup previous infra
      crystian.incus.incus_remote:
        name: "{{ remote_name }}"
        state: absent
      when: delete_infra | default(false) | bool
      ignore_errors: true

    - name: Cleanup previous VM
      crystian.incus.incus_instance:
        name: "{{ vm_name }}"
        state: absent
        force: true
      when: delete_infra | default(false) | bool
      ignore_errors: true

    - name: Create Test VM (Debian 13)
      crystian.incus.incus_instance:
        name: "{{ vm_name }}"
        remote_image: "{{ image_name }}"
        vm: true
        config:
          limits.cpu: "2"
          limits.memory: "2GiB"
        started: true
        state: present
      register: infra_vm

    - name: Wait for VM networking
      wait_for:
        timeout: 60

    - name: Install dependencies (curl, gpg)
      crystian.incus.incus_exec:
        instance_name: "{{ vm_name }}"
        command: "sh -c 'apt-get update && apt-get install -y ca-certificates curl gnupg lvm2 btrfs-progs'"
      register: dep_install
      retries: 3
      delay: 5
      until: dep_install.rc == 0

    - name: Setup Zabbly Key
      crystian.incus.incus_exec:
        instance_name: "{{ vm_name }}"
        command: "sh -c 'mkdir -p /etc/apt/keyrings; curl -fsSL https://pkgs.zabbly.com/key.asc -o /etc/apt/keyrings/zabbly.asc'"

    - name: Setup Zabbly Repo
      crystian.incus.incus_exec:
        instance_name: "{{ vm_name }}"
        command: "sh -c 'echo \"deb [signed-by=/etc/apt/keyrings/zabbly.asc] https://pkgs.zabbly.com/incus/daily $(. /etc/os-release && echo ${VERSION_CODENAME}) main\" > /etc/apt/sources.list.d/zabbly-incus-daily.list'"

    - name: Install Incus
      crystian.incus.incus_exec:
        instance_name: "{{ vm_name }}"
        command: "sh -c 'apt-get update && apt-get install -y incus'"
      register: incus_install

    - name: Check Incus Init
      crystian.incus.incus_exec:
        instance_name: "{{ vm_name }}"
        command: "incus info"
      register: incus_info
      ignore_errors: true

    - name: Initialize Incus
      crystian.incus.incus_exec:
        instance_name: "{{ vm_name }}"
        command: "incus admin init --minimal"
      when: incus_info.rc != 0
    
    - name: Config bind address
      crystian.incus.incus_exec:
        instance_name: "{{ vm_name }}"
        command: "incus config set core.https_address :8443"

    - name: Config trust token
      crystian.incus.incus_exec:
        instance_name: "{{ vm_name }}"
        command: "incus config trust add ansible-client --quiet"
      register: trust_token_out

    - name: Get VM IP
      crystian.incus.incus_list:
        filters:
          - "{{ vm_name }}"
      register: vm_info

    - name: Parse IP
      set_fact:
         vm_ip: "{{ (vm_info.list | first).state.network | dict2items | map(attribute='value.addresses') | flatten | selectattr('family', 'equalto', 'inet') | map(attribute='address') | first }}"

    - name: Add Remote
      crystian.incus.incus_remote:
        name: "{{ remote_name }}"
        url: "https://{{ vm_ip }}:8443"
        token: "{{ trust_token_out.stdout | trim }}"
        accept_certificate: true

    - name: Create incusbr0 network (nested)
      command: "incus network create {{ remote_name }}:incusbr0"
      delegate_to: localhost
      ignore_errors: true

    - name: Create default storage pool (nested)
      crystian.incus.incus_storage:
        pool: default
        driver: dir
        config:
          source: /var/lib/incus/storage-pools/default
        state: present
        remote: "{{ remote_name }}"
      delegate_to: localhost

    - name: Install OVN dependencies
      crystian.incus.incus_exec:
        instance_name: "{{ vm_name }}"
        command: "sh -c 'apt-get update && apt-get install -y ovn-host ovn-central openvswitch-switch'"
      register: ovn_install
      retries: 3
      delay: 5
      until: ovn_install.rc == 0

    - name: Configure OVS for OVN
      crystian.incus.incus_exec:
        instance_name: "{{ vm_name }}"
        command: "ovs-vsctl set open_vswitch . external_ids:ovn-remote=unix:/run/ovn/ovnsb_db.sock external_ids:ovn-encap-type=geneve external_ids:ovn-encap-ip=127.0.0.1"

    - name: Enable OVN services
      crystian.incus.incus_exec:
        instance_name: "{{ vm_name }}"
        command: "systemctl enable --now ovn-central ovn-host"

    - name: Configure Incus OVN connection (optional but good practice)
      crystian.incus.incus_exec:
        instance_name: "{{ vm_name }}"
        command: "incus config set network.ovn.northbound_connection unix:/run/ovn/ovnnb_db.sock"

    - name: Create default profile root disk (nested)
      crystian.incus.incus_profile:
        name: default
        devices:
          root:
            path: /
            pool: default
            type: disk
        state: present
        remote: "{{ remote_name }}"
      delegate_to: localhost

    - name: Create setup marker
      file:
        path: .test_setup_complete
        state: touch
