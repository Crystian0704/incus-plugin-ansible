---
- name: Provision Test Infrastructure
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    vm_name: "test-infra-vm"
    remote_name: "test-infra"
    image_name: "images:debian/13"

  tasks:
    - name: Check for setup marker
      stat:
        path: .test_setup_complete
      register: setup_marker

    - name: End play if setup is complete
      meta: end_play
      when:
        - false # FORCE RUN
        - not (delete_infra | default(false) | bool)

    - name: Cleanup previous infra
      crystian.incus.incus_remote:
        name: "{{ remote_name }}"
        state: absent
      when: delete_infra | default(false) | bool
      ignore_errors: true

    - name: Cleanup previous VM
      crystian.incus.incus_instance:
        name: "{{ vm_name }}"
        state: absent
        force: true
      when: delete_infra | default(false) | bool
      ignore_errors: true

    - name: Create Test VM (Debian 13)
      crystian.incus.incus_instance:
        name: "{{ vm_name }}"
        remote_image: "{{ image_name }}"
        vm: true
        config:
          limits.cpu: "2"
          limits.memory: "2GiB"
        started: true
        state: present
      register: infra_vm

    - name: Wait for VM networking
      wait_for:
        timeout: 60

    - name: Add host to inventory
      add_host:
        name: "{{ vm_name }}"
        groups: build_group
        ansible_connection: community.general.incus
        ansible_incus_remote: local
        ansible_user: root

- name: Configure Test Infrastructure
  hosts: build_group
  gather_facts: false
  tasks:
    - name: Install Python (raw)
      raw: apt-get update && apt-get install -y python3
      changed_when: false

    - name: Gather Facts
      setup:

    - name: Install dependencies
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - lvm2
          - btrfs-progs
          - python3-yaml
        state: present
        update_cache: yes

    - name: Setup Zabbly Key
      shell: "mkdir -p /etc/apt/keyrings; curl -fsSL https://pkgs.zabbly.com/key.asc -o /etc/apt/keyrings/zabbly.asc"
      args:
        creates: /etc/apt/keyrings/zabbly.asc

    - name: Setup Zabbly Repo
      shell: "echo \"deb [signed-by=/etc/apt/keyrings/zabbly.asc] https://pkgs.zabbly.com/incus/daily $(. /etc/os-release && echo ${VERSION_CODENAME}) main\" > /etc/apt/sources.list.d/zabbly-incus-daily.list"

    - name: Install Incus
      apt:
        name: incus
        state: present
        update_cache: yes

    - name: Start Incus Service (if not running)
      service:
        name: incus
        state: started
        enabled: yes

    - name: Initialize Incus
      crystian.incus.incus_admin_init:
        minimal: true

    - name: Config bind address
      crystian.incus.incus_config:
        config:
          core.https_address: ":8443"
    
    - name: Config trust token
      crystian.incus.incus_config:
        trust:
          name: ansible-client
      register: trust_token_out

    - name: Install OVN dependencies
      apt:
        name:
          - ovn-host
          - ovn-central
          - openvswitch-switch
        state: present

    - name: Configure OVS for OVN
      command: "ovs-vsctl set open_vswitch . external_ids:ovn-remote=unix:/run/ovn/ovnsb_db.sock external_ids:ovn-encap-type=geneve external_ids:ovn-encap-ip=127.0.0.1"

    - name: Enable OVN services
      service:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop:
        - ovn-central
        - ovn-host

    - name: Configure Incus OVN connection
      crystian.incus.incus_config:
        config:
          network.ovn.northbound_connection: "unix:/run/ovn/ovnnb_db.sock"

- name: Finalize Setup (Localhost)
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    vm_name: "test-infra-vm"
    remote_name: "test-infra"
  tasks:
    - name: Get VM IP
      set_fact:
         vm_ip: "{{ query('crystian.incus.incus_list', vm_name) | map(attribute='state.network') | list | first | dict2items | map(attribute='value.addresses') | flatten | selectattr('family', 'equalto', 'inet') | map(attribute='address') | first }}"

    - name: Set Token Fact
      set_fact:
        trust_token: "{{ hostvars[vm_name]['trust_token_out']['token'] | default(hostvars[vm_name]['trust_token_out'].get('stdout', '') | trim) }}"

    - name: Add Remote
      crystian.incus.incus_remote:
        name: "{{ remote_name }}"
        url: "https://{{ vm_ip }}:8443"
        token: "{{ trust_token }}"
        accept_certificate: true

    - name: Create incusbr0 network (nested)
      crystian.incus.incus_network:
         name: incusbr0
         type: bridge
         remote: "{{ remote_name }}"
         state: present

    - name: Create default storage pool (nested)
      crystian.incus.incus_storage:
        pool: default
        driver: dir
        config:
          source: /var/lib/incus/storage-pools/default
        state: present
        remote: "{{ remote_name }}"
      delegate_to: localhost

    - name: Create default profile root disk (nested)
      crystian.incus.incus_profile:
        name: default
        devices:
          root:
            path: /
            pool: default
            type: disk
        state: present
        remote: "{{ remote_name }}"
      delegate_to: localhost

    - name: Create setup marker
      file:
        path: .test_setup_complete
        state: touch
